name: damask_plastic_parameter_fitting

stats: false
run_options:
  l: short
archive: dropbox

iterate:
  parameter: single_crystal_parameters
  num_iterations: 4

tasks:
  - name: generate_microstructure_seeds
    method: random
    software: damask
    base:
      grid_size: [120, 120, 120]
      num_grains: 1000
      size: [1, 1, 1] 
    output_map_options:
      phase_label: Al 
      
  - name: sample_texture
    method: from_CTF_file
    software: mtex
    base:
      #CTF_file_path: /net/2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 1 - EBSD Data Map_001.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 2 - EBSD Data Map_002.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 1 - EBSD Data Map_003.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 2 - EBSD Data Map_004.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 1 - EBSD Data Map_005.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 2 - EBSD Data Map_006.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 1 - EBSD Data Map_007.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 2 - EBSD Data Map_008.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 1 - EBSD Data Map_009.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 2 - EBSD Data Map_010.ctf
      #CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Map Data 1 - EBSD Data Map_011.ctf
      CTF_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/EBSD Montaged Map Data - EBSD Data Map_001.ctf
      
      specimen_symmetry: orthorhombic
      phase: Aluminium # Change to mtex phase
      num_orientations: 1000
    output_map_options:
      orientation_coordinate_system:
        x: RD
        y: TD
        z: ND
        
  - name: generate_volume_element
    method: random_voronoi_from_orientations
    software: damask
    base:
      #size: [1, 1, 1]
      homog_label: SX
      scale_morphology: [1, 1, 1]
      
  - name: visualise_volume_element
    method: VTK
    software: damask

  - name: generate_load_case
    method: uniaxial
    software: formable
    base:
      total_times:         [100]
      num_increments:      [400]
      target_strain_rates: [5e-4]
      directions:          [x]

  - name: get_tensile_test
    method: from_CSV
    software: formable
    base:
      CSV_file_path: /net/scratch2/j06992lg/Parameter_fitting/Texture_data/T6 tensile data.csv
      CSV_arguments:
        delimiter: ';'
        skip_rows: 1
        header_row: 0
      true_strain_col_index: 3
      true_stress_col_index: 2
      stress_units: MPa

  - name: simulate_volume_element_loading
    method: CP_FFT
    software: DAMASK
    run_options:
      num_cores: 4
      processing:
        num_cores: 4
    output_map_options:
      operations:
        - name: add_Cauchy
          args: {P: P, F: F}
          opts: {add_Mises: true}
        - name: add_strain_tensor
          args: {F: F, t: V, m: 0}
          opts: {add_Mises: true}
      incremental_data:
        - name: vol_avg_equivalent_stress
          path: constituent/1_Al/generic/sigma_vM
          transforms: [mean_along_axes: 1]
        - name: vol_avg_equivalent_strain
          path: constituent/1_Al/generic/epsilon_V^0(F)_vM
          transforms: [mean_along_axes: 1]
    base:
      single_crystal_parameters:
        Al:
          h_0_sl_sl: 700e7 #Hardening related (keep)
          xi_0_sl: [100e6] #YS related (we need to decrease it from 180e6)
          xi_inf_sl: [160e6] #UTS related (maybe decrease it the same quantity as xi_0sl from 240e6)
      homogenization_schemes:
        SX:
          mech:
            type: none
      phases:
        Al:
          elasticity:
            type: hooke
            C_11: 107.3e9
            C_12: 60.9e9
            C_44: 28.3e9
          generic:
            output: [F, P, Fp]
          lattice: fcc
          plasticity:
            type: phenopowerlaw
            single_crystal_parameters: Al
            N_sl: [12]
            a_sl: 2.25
            atol_xi: 1.0
            dot_gamma_0_sl: 0.001            
            h_sl_sl: [1, 1, 1.4, 1.4, 1.4, 1.4]
            n_sl: 20
            output: [xi_sl]            
    sequences:
      - name: single_crystal_parameter_perturbation
        vals:
          - perturbation: null
          - address: [Al, h_0_sl_sl]
            perturbation: 0.05
          - address: [Al, xi_0_sl, 0]
            perturbation: 0.05
          - address: [Al, xi_inf_sl, 0]
            perturbation: 0.05
    groups:
      single_crystal_parameter_optimisation:
        group_by: []
        nest: True
 
  - name: optimise_single_crystal_parameters
    method: levenberg_marquardt
    software: formable
    base:
      initial_damping: [2.0, 1.0, 0.5]